<!DOCTYPE html>
    <head>
        <style>

            body{
                background-color: black;
                color: white;
            }

            input{
                margin-left: 20px;
                background-color: black;
                color: white;
                border: 0px;
                padding-left: 25px;
                width: 50px;
            }

            textarea{
                background-color: black;
                color: white;
                letter-spacing: 10px;
                line-height: 20px;
                padding: 20px;
                padding-left: 25px;
                border: 0px;
                overflow: hidden;
                resize:none;
                margin:20px;
                margin-top:0px;
                margin-bottom:0px;
            }

            .synth{
                padding-top: 20px;
                display: inline-block;
                border: 1px dotted white;
            }

        </style>

        <script src="js/jquery.min.js"></script>
        <script src="js/Tone.js"></script>

        <script>

            var tempo = "2n";
            var currentColumn = 0;
            var numCharacters = 400;
            var maxColumns = 20;
            var loopUpdate = false;

            function sequencer(notes){
                var now = Tone.now();
                var synth = new Tone.PolySynth(Tone.Synth).toTransport();
                for(i = 0; i < notes.length; i++){
                    note = notes[i].split("_");
                    pitch = note[0];
                    duration = parseFloat(note[1]);
                    console.log("note: "+pitch+ " duration:"+duration);
                    synth.triggerAttack(pitch, now);
                    synth.triggerRelease(notes[i], now + duration)
                    now += duration;
                }
            }

            $('document').ready(function(){
                var input = document.getElementById('q');

                input.onkeydown = function() {
                    var key = event.keyCode || event.charCode;
                    
                    if( (key > 58 || key < 47) && key != 190 && key != 37 && key != 38 && key != 39 && key != 40  ){
                        return false;
                        
                }
                    var s = this.selectionStart;
                    console.log(s);
                if(s >= numCharacters) {
                    console.log('error');
                    return false;
                }

                };


                input.addEventListener('keypress', function(event){
                        
                
                    var s = this.selectionStart;
                
                this.value = this.value.substr(0, s) + this.value.substr(s + 1);
                    
                
                    this.selectionEnd = s;

                    loopUpdate = true;
                    
                    
                }, false);

            });

                    // Membrane Synth https://tonejs.github.io/docs/r12/MembraneSynth
                    const synth = new Tone.MembraneSynth().toMaster();

                    const loop = new Tone.Loop(function(time) {
                           
                          var notes = getCurrentNotes();
                          for (const note of notes) {
                                synth.triggerAttackRelease(note, tempo);
                          }
                        
                        
                        /*for(i = 0; i++; notes.length){
                            synth.triggerAttackRelease(notes[i], tempo);
                        }
                        
                        */
                    }, tempo).start(0);

                    let playing = false;
                        
                    function playStop(){
                        if (!playing) {
                        Tone.Transport.start();
                        playing = true;
                        } else {
                        playing= false;
                        Tone.Transport.stop();
                        }
                    }

                    
                    string_chop =  function(str, size){
                        if (str == null) return [];
                        str = String(str);
                        size = ~~size;
                    return size > 0 ? str.match(new RegExp('.{1,' + size + '}', 'g')) : [str];
                    }

                    function getCurrentNotes(){

                        var rows = string_chop($('textarea').val(),20);
                        var currentNotes = [];
                        for(var i = 0; i < rows.length; i++){
                            if(rows[i][currentColumn] != '.'){
                                console.log(rows[i][currentColumn]);
                                currentNotes.push((i*40)+"");
                            }

                        }
                        console.log(currentNotes);
                        currentColumn = (currentColumn + 1) % maxColumns;
                        //console.log(currentColumn);
                        return currentNotes;
                    }

                    playStop();
                    

            

        </script>
    </head>
    <body>
        <div class="synth">
            <p><input placeholder="synth" /><input placeholder="volume" /><input placeholder="reverb" /><input placeholder="tempo" /></p>
            <p><input placeholder="minHz" /><input placeholder="maxHz" /><input placeholder="discrete" /></p>
            <p><textarea maxlength="400" cols="20" rows="20" id="q">....................1....................1....................1.......1............1.....1.1......11....1...1...1............1.1.....1...1........1.......1.1..................1....................................................................................4...4...4..4...4...4............................................................22222222222222222222........................................</textarea>
            <p><span id="col0"></span><span id="col1"></span><span id="col2"></span><span id="col3"></span><span id="col4"></span><span id="col5"></span><span id="col6"></span><span id="col7"></span><span id="col8"></span><span id="col9"></span><span id="col10"></span><span id="col11"></span><span id="col12"></span><span id="col13"></span><span id="col14"></span><span id="col1"></span><span id="col15"></span><span id="col16"></span><span id="col17"></span><span id="col18"></span><span id="col19"></span></p>
        </div>
        </body>
</html>
  